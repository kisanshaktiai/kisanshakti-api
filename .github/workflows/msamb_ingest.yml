name: msamb-ingest

on:
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *'   # every 30 minutes (adjust as needed)

jobs:
  run-ingest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

     # snippet - replace the two steps "Install deps" and "Run ingestion script" with this block
     
  - name: Debug repo layout & locate script
        run: |
          echo "=== RUNNER PWD ==="
          pwd
          echo ""
          echo "=== repo root listing ==="
          ls -la
          echo ""
          echo "=== find fetch_real_marketdata.py ==="
          find . -maxdepth 4 -type f -name "fetch_real_marketdata.py" -print || true
          echo ""
          echo "=== find requirements.txt ==="
          find . -maxdepth 4 -type f -name "requirements.txt" -print || true
    
  - name: Install deps (auto-locate requirements)
    env:
      PIP_NO_INPUT: "1"
    run: |
      REQ=$(find . -maxdepth 4 -type f -name "requirements.txt" | head -n1)
      if [ -z "$REQ" ]; then
        echo "No requirements.txt found under repo, skipping pip install"
      else
        echo "Installing from $REQ"
        python -m pip install --upgrade pip
        pip install -r "$REQ"
      fi
  
  - name: Run ingestion script (auto-locate)
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      COMMODITY_HTML_DIR: ./market-api
      REQUESTS_TIMEOUT: 30
      THROTTLE_SECONDS: 1.2
    run: |
      SCRIPT=$(find . -maxdepth 4 -type f -name "fetch_real_marketdata.py" | head -n1)
      if [ -z "$SCRIPT" ]; then
        echo "ERROR: fetch_real_marketdata.py not found!"
        echo "Repo layout:"
        pwd
        ls -la
        exit 2
      fi
      echo "Found script: $SCRIPT"
      echo "Running: python $SCRIPT"
      python "$SCRIPT"


